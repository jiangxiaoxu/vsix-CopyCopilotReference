name: publish-release

on:
  push:
    branches:
      - release

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - uses: NuGet/setup-nuget@v2
      - name: Restore
        run: nuget restore CopyCopilotReference.csproj
      - name: Build
        run: msbuild CopyCopilotReference.csproj /p:Configuration=Release /p:Platform=AnyCPU
      - name: Publish VSIX
        env:
          VS_MARKETPLACE_TOKEN: ${{ secrets.VS_MARKETPLACE_TOKEN }}
        run: |
          if (-not $env:VS_MARKETPLACE_TOKEN) { throw "VS_MARKETPLACE_TOKEN is not set" }
          $vsix = Get-ChildItem -Path bin\Release -Filter *.vsix -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $vsix) { throw "VSIX not found in bin\\Release" }
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) { throw "vswhere.exe not found at $vswhere" }
          $vsInstall = & $vswhere -latest -format json | ConvertFrom-Json
          if (-not $vsInstall) { throw "Visual Studio installation not found" }
          $vsixPublisher = Join-Path $vsInstall[0].installationPath "VSSDK\VisualStudioIntegration\Tools\Bin\VsixPublisher.exe"
          if (-not (Test-Path $vsixPublisher)) { throw "VsixPublisher.exe not found at $vsixPublisher" }
          & $vsixPublisher publish -payload $vsix.FullName -publishManifest publishManifest.json -personalAccessToken $env:VS_MARKETPLACE_TOKEN
